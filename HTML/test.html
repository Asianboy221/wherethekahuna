<!DOCTYPE html>
<html>

<head>
  <title>Where the Kahuna</title>
  <link rel="stylesheet" type="text/css" href="../Stylesheets/main.css">
  <link rel="icon" href="http://flaglane.com/download/american-flag/american-flag-large.gif">
  <meta name="viewport" content="initial-scale=1.0">
  <meta charset="utf-8">
  <style>
    /* Always set the map height explicitly to define the size of the div
       * element that contains the map. */

    #map {
      height: 100%;
      width: auto;
      margin: 50px;
      margin-bottom: 0px;
      display: table-cell;
      vertical-align: middle
    }
  </style>
</head>

<body>
  <section class="gridlayout">
    <section class="upper" id="map">
      <!-- <div id="map"></div> -->
    </section>
    <section class="lower">
      <h3 id="displayName"></h3>
      <section class="displaygrid">
        <img id="displayPhoto"/>
        <div id="displayHours"></div>
        <div id="displayRating"></div>
        <div id="displayAddress"></div>
      </section>
      
    </section>
  </section>
  <script>
    var map, infoWindow, pos, placeLoc, directionsService, directionsDisplay;
    //var findInput = document.getElementById("find").value;
    //var findInput = document.getElementById("location").value;

    function initMap() {
      // The starting location of Salt Lake City
      var startingLocation = { lat: 40.760779, lng: -111.891047 };
      directionsService = new google.maps.DirectionsService;
      directionsDisplay = new google.maps.DirectionsRenderer;
      // The map, centered at Salt Lake City
      map = new google.maps.Map(document.getElementById('map'), {
        zoom: 13,
        center: startingLocation
      });
      directionsDisplay.setMap(map);
      directionsDisplay.setOptions({suppressMarkers: true})
      infoWindow = new google.maps.InfoWindow;
      // Try HTML5 geolocation.
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function (position) {
          //Getting current location
          pos = {
            lat: position.coords.latitude,
            lng: position.coords.longitude
          };
          map.panTo(pos);
          //Center map over current location add marker to current location
          map.setCenter(pos);
          var icon = {
            url: "../img/usflag.png", // url
            scaledSize: new google.maps.Size(50, 50), // scaled size
            origin: new google.maps.Point(0, 0), // origin
          };
          var currentlocation = {
            url: "../img/currentlocation.png", // url
            scaledSize: new google.maps.Size(50, 50), // scaled size
            origin: new google.maps.Point(0, 0), // origin
          };
          var marker = new google.maps.Marker({
            position: pos,
            map: map,
            animation: google.maps.Animation.DROP,
            icon: currentlocation
          });

          var service = new google.maps.places.PlacesService(map);
          service.nearbySearch({
            location: pos,
            radius: 1609, //1 Mile
            keyword: [getRandomFood()],
            type: ['restaurant']
          }, callback);
          var request = {
            location: map.getCenter(),
            radius: 1609,
            //query: getRandomFood()
            //icon: icon
          }
        }, function () {
          handleLocationError(true, infoWindow, map.getCenter());
        });
      } else {
        // Browser doesn't support Geolocation
        handleLocationError(false, infoWindow, map.getCenter());
      }
      
    }
    function getRandomFood() {
      var foods = [
        "Burgers",
        "Chinese",
        "Mediterranean",
        "Cheesesteaks",
        "Chicken",
        "Fast Food",
        "Vietnamese"
      ];
      var food = foods[Math.floor(Math.random() * foods.length)]
      console.log(food);
      return food;
    }
    function handleLocationError(browserHasGeolocation, infoWindow, pos) {
      infoWindow.setPosition(pos);
      infoWindow.setContent(browserHasGeolocation ?
        'Error: The Geolocation service failed.' :
        'Error: Your browser doesn\'t support geolocation.');
      infoWindow.open(map);
    }

    function callback(results, status) {
      if (status == google.maps.places.PlacesServiceStatus.OK) {
        var marker = new google.maps.Marker({
          map: map,
          place: {
            placeId: results[0].place_id,
            location: results[0].geometry.location,
            icon: createMarker(results[0])
          }
        });
      }
      calculateAndDisplayRoute(directionsService, directionsDisplay);
      updateDisplay(results[0], status);
    }

    function updateDisplay(result, status) {
      if(status == google.maps.places.PlacesServiceStatus.OK) {
        console.log(JSON.stringify(result));
        document.getElementById('displayName').innerHTML = result.name;
        var photos = result.photos;
        document.getElementById('displayPhoto').src = photos[0].getUrl({'maxWidth': 350, 'maxHeight': 250});
        document.getElementById('displayHours').innerHTML = result.opening_hours.weekday_text;
        document.getElementById('displayRating').innerHTML = result.rating;
        document.getElementById('displayAddress').innerHTML = result.vicinity;
      }
    }
    //function callback(results, status) {
    //if (status === google.maps.places.PlacesServiceStatus.OK) {
    //for (var i = 0; i < results.length; i++) {
    //createMarker(results[i]);
    //}
    //}
    //}
    //Add Markers to nearby places
    function createMarker(place) {
      placeLoc = place.geometry.location;
      var photos = place.photos;
      if (!photos) {
        return;
      }
      var icon = {
        url: "../img/locations.png", // url
        scaledSize: new google.maps.Size(50, 50), // scaled size
        origin: new google.maps.Point(0, 0), // origin
      };
      var marker = new google.maps.Marker({
        map: map,
        position: place.geometry.location,
        animation: google.maps.Animation.DROP,
        icon: icon//photos[0].getUrl({ 'maxWidth': 35, 'maxHeight': 35 })
      });

      google.maps.event.addListener(marker, 'click', function () {
        infowindow.setContent(place.name);
        infowindow.open(map, this);
      });
    }

    function handleLocationError(browserHasGeolocation, infoWindow, pos) {
      infoWindow.setPosition(pos);
      infoWindow.setContent(browserHasGeolocation ?
        'Error: The Geolocation service failed.' :
        'Error: Your browser doesn\'t support geolocation.');
      infoWindow.open(map);
    }
    function calculateAndDisplayRoute(directionsService, directionsDisplay) {
        directionsService.route({
          origin: pos,
          destination: placeLoc,
          travelMode: 'DRIVING'
        }, function(response, status) {
          if (status === 'OK') {
            directionsDisplay.setDirections(response);
          } else {
            window.alert('Directions request failed due to ' + status);
          }
        });
      }
  </script>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAubZQ79mLt-Yli8Mac-8I4Nl56j8Y2W3s&libraries=places&callback=initMap"
    async defer></script>
</body>

</html>